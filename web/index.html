<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>ARBITRATOR Live View</title>
        <link href="ptoc.css" rel="stylesheet" type="text/css">
        <script language="javascript" type="text/javascript" src="flot/jquery.min.js"></script>
        <script language="javascript" type="text/javascript" src="flot/jquery.flot.min.js"></script>
        <script language="javascript" type="text/javascript" src="flot/jquery.flot.navigate.min.js"></script>
        <script language="javascript" type="text/javascript" src="flot/jquery.flot.time.js"></script>

        <script type="text/javascript">

            var graphMode = "0";
            var graphExchange = "0";
            var graphCoin = "BTC";

            var stats = null;

            $(function() {

                $(".showGraph").live("click", function() {

                    var coin = $(this).attr("coin");
                    var exid = $(this).attr("exchange");
                    var mode = $(this).attr("mode");

                    graphMode = mode;
                    graphExchange = exid;
                    graphCoin = coin;

                    updateGraph();
                });

                var walletAge = 0;

                function no2e(x) {

                    if (x === "1" || x === 1)
                        return "P";
                    else if (x === "2" || x === 2)
                        return "C";
                    else if (x === "3" || x === 3)
                        return "B";
                    else if (x === "4" || x === 4)
                        return "A";
                    else if (x === "5" || x === 5)
                        return "L";
                    else if (x === "6" || x === 6)
                        return "K";
                    else
                        return "?";

                }

                function no2el(x) {

                    if (x === "0" || x === 0)
                        return "TOTAL";
                    else if (x === "1" || x === 1)
                        return "PLNX";
                    else if (x === "2" || x === 2)
                        return "CRYPTSY";
                    else if (x === "3" || x === 3)
                        return "BTTRX";
                    else if (x === "4" || x === 4)
                        return "LLCN";
                    else if (x === "5" || x === 5)
                        return "BLTRD";
                    else if (x === "6" || x === 6)
                        return "CMKRT";
                    else
                        return "?";

                }

                function rnd1(x) {
                    return Math.round(x * 10) / 10;
                }

                function rnd4(x) {
                    return (Math.round(x * 10000) / 10000).toFixed(4);
                }

                function updateGraph() {
                    setTimeout(updateGraph, 90000);

                    if (graphMode === "0") {
                        $("#graphHeading").html(graphCoin + " balance @ " + no2el(graphExchange));
                    } else if (graphMode === "1") {
                        $("#graphHeading").html(graphCoin + " rate @ " + no2el(graphExchange));
                    } else {
                        $("#graphHeading").html(graphCoin + " desired balance @ " + no2el(graphExchange));
                    }

                    $.ajax({
                        url: "graph.php?coin=" + graphCoin + "&exchange=" + graphExchange + "&mode=" + graphMode,
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var obj = {};

                            for (var i = 0; i < data.length; i++) {
                                for (var x = 0; x < data[i].length; x++) {
                                    var d1 = [data[i][x].time * 1000, data[i][x].value];
                                    var exchange = data[i][x].exchange;
                                    if (exchange === undefined) {
                                        continue;
                                    }
				    if (!obj[exchange]) {
					obj[exchange] = [];
				    }
				    obj[exchange].push(d1);
                                }
                            }

                            var exchanges = Object.keys(obj);
                            var arrs = [];
                            for (i = 0; i < exchanges.length; i++) {
                                arrs.push({ data: obj[exchanges[i]], label: no2el(exchanges[i]) });;
                            }


                            var endDate = new Date();
                            var startDate = new Date();
                            startDate.setHours(endDate.getHours() - 48);

                            var plot = $.plot("#placeholder", arrs, {
                                label: no2el(graphExchange),
                                legend: {
                                    show: true,
                                    position: "nw",
                                    noColumns: 1
                                },
                                zoom: {
                                    interactive: true
                                },
                                pan: {
                                    interactive: true
                                },
                                xaxis: {
                                    mode: "time",
                                    min: startDate.getTime(),
                                    max: endDate.getTime()
                                }
                            });
                        }
                    });
                }

                function updateLog() {
                    setTimeout(updateLog, 10000);
                    $.ajax({
                        url: "log.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var htmlData = "<pre>";
                            for (var i = 0; i < data.length; i++) {
                                var date = new Date(data[i].time * 1000);
                                var hours = date.getHours();
                                var minutes = date.getMinutes();
                                var seconds = date.getSeconds();
                                if (hours < 10)
                                    hours = "0" + hours;
                                if (minutes < 10)
                                    minutes = "0" + minutes;
                                if (seconds < 10)
                                    seconds = "0" + seconds;
                                var formattedTime = hours + ':' + minutes + ':' + seconds;
                                htmlData = "[" + formattedTime + "] " + data[i].message + "\n" + htmlData;
                            }

                            $("#logfile").html("<pre>" + htmlData + "</pre>");
                        }
                    });
                }

                function timeLeft(futureTime) {

                    var delta = (futureTime * 1000 - new Date()) / 1000;
                    if (delta < 0) {
                        return "soon";
                    }

                    var hours = new String(Math.floor(delta / 3600));
                    delta -= hours * 3600;
                    if (hours.length < 2)
                        hours = "0" + hours;

                    var minutes = new String(Math.floor(delta / 60) % 60);
                    delta -= minutes * 60;
                    if (minutes.length < 2)
                        minutes = "0" + minutes;

                    var seconds = new String(Math.floor(delta));
                    if (seconds.length < 2)
                        seconds = "0" + seconds;

                    return hours + ":" + minutes + ":" + seconds;
                }

                function updateAge() {
                    setTimeout(updateAge, 1000);
                    walletAge++;

                    var age;
                    if (walletAge > 60) {
                        age = Math.floor(walletAge / 60) + "m";
                    } else {
                        age = walletAge + "s";
                    }
                    $("#wage").html("Wallets (" + age + ")");
                }

                function updateManagement() {
                    setTimeout(updateManagement, 60000);
                    $.ajax({
                        url: "management.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var htmlData = "";
                            for (var i = 0; i < data.length && i <= 15; i++) {
                                var coin = data[i].coin;
                                while (coin.length < 5) {
                                    coin = coin + " ";
                                }
                                var amount = String(rnd1(data[i].amount));
                                if (data[i].amount > 0)
                                    amount = "+" + amount;

                                while (amount.length < 7) {
                                    amount = " " + amount;
                                }

                                htmlData += amount + " " + coin;
                                htmlData += " @ ";
                                htmlData += no2el(data[i].exchange);
                                htmlData += "\n";
                            }

                            $("#management").html("<pre>" + htmlData + "</pre>");
                        }
                    });
                }

                function updateXfers() {
                    setTimeout(updateXfers, 60000);
                    $.ajax({
                        url: "xfer.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var htmlData = "";
                            for (var i = 0; i <= 15 && i < data.length; i++) {
                                var coin = data[i].coin;
                                while (coin.length < 5) {
                                    coin = coin + " ";
                                }
                                var amount = new String(data[i].amount);
                                amount = amount.substr(0, amount.indexOf('.') + 3);
                                while (amount.length < 8) {
                                    amount = " " + amount;
                                }

                                var profit = new String(data[i].profit);
                                profit = profit.substr(0, profit.indexOf('.') + 5);
                                profit = profit + " BTC";
                                while (profit.length < 11) {
                                    profit = " " + profit;
                                }

                                var direction = "";
                                direction += no2e(data[i].exchange_source);
                                direction += " -> ";
                                direction += no2e(data[i].exchange_target);

                                htmlData += amount + " " + coin + " " + direction + "\n";
                            }

                            $("#xfers").html("<pre>" + htmlData + "</pre>");
                        }
                    });
                }

                function updateTrades() {
                    setTimeout(updateTrades, 60000);
                    $.ajax({
                        url: "trades.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var htmlData = "";
                            for (var i = 0; i <= 15 && i < data.length; i++) {

                                var coin = new String(data[i].coin);
                                while (coin.length < 5) {
                                    coin = coin + " ";
                                }

                                var amount = new String(data[i].amount);
                                amount = amount.substr(0, amount.indexOf('.') + 3);
                                while (amount.length < 8) {
                                    amount = " " + amount;
                                }
                                htmlData += amount + " " + coin + " SOLD @ " + no2el(data[i].exchange) + "\n";
                            }

                            $("#trades").html("<pre>" + htmlData + "</pre>");
                        }
                    });
                }

                function formatBalance(b) {
                    var rval = new String(b);
                    rval = rval.substr(0, rval.indexOf('.') + 3);
                    return rval;
                }

                function genWhitespace(b, len) {
                    var rval = "";
                    while (rval.length + b.length < len) {
                        rval = " " + rval;
                    }
                    return rval;
                }

                function fmt2(b) {
                    var rval = new String(Math.min(99, b));
                    if (rval.length < 2) {
                        rval = "0" + rval;
                    }
                    return rval;
                }

                function updateWallets() {
                    setTimeout(updateWallets, 60000);
                    $.ajax({
                        url: "wallets.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {

                            var wallets = data['wallets'];
                            walletAge = data['age'];
                            var tradeCounts = data['trades'];
                            var useCounts = data['uses'];

                            var htmlData = "---------- <span title=\"Currency\">BTC</span> -----------\n";

                            var btcData = wallets['BTC'];
                            var total = 0;
                            var totalChange = 0;

                            Object.keys(btcData).forEach(function(xid) {

                                var exname = no2el(xid);
                                while (exname.length < 8) {
                                    exname = " " + exname;
                                }

                                htmlData += exname;
                                htmlData += ": ";
                                htmlData += "<a href=\"#\" coin=\"BTC\" exchange=\"" + xid + "\" mode=\"0\" class=\"showGraph\" title=\"Total balance (BTC)\">";
                                htmlData += rnd4(btcData[xid]['balance']);
                                htmlData += "</a>";
                                htmlData += " T:";
                                htmlData += "<span title=\"Trade counts\">";
                                htmlData += fmt2(tradeCounts[xid]);
                                htmlData += "</span>|O:";
                                htmlData += "<span title=\"Opportunity counts\">";
                                htmlData += fmt2(useCounts[xid]);
                                htmlData += "</span>\n";
                                total += parseFloat(btcData[xid]['balance']);
                                totalChange += parseFloat(btcData[xid]['change']);
                            });

                            htmlData += "   TOTAL: ";
                            htmlData += "<a href=\"#\" coin=\"BTC\" exchange=\"0\" mode=\"0\" class=\"showGraph\" title=\"Total balance (BTC)\">";
                            htmlData += rnd4(total);
                            htmlData += "</a>";
                            htmlData += " <span title=\"Total balance change (BTC)\">";
                            htmlData += totalChange > 0 ? "+" : "";
                            htmlData += rnd4(totalChange);
                            htmlData += "</span>\n";
                            htmlData += "--------------------------\n";
                            htmlData += "\n";

                            Object.keys(wallets).forEach(function(coin) {

                                if (coin === "BTC") {
                                    return;
                                }

                                var dataset = wallets[coin];
                                var valid = false;
                                Object.keys(dataset).forEach(function(xid) {
                                    valid |= dataset[xid]['opportunities'] > 0 || dataset[xid]['balance'] > 0;
                                });

                                if (!valid) {
                                    return;
                                }

                                var dashes = "";
                                var strCoin = coin + " ";
                                while ((strCoin + dashes).length < 25) {
                                    dashes += "-";
                                }
                                htmlData += "<span title=\"Currency\">" + strCoin + "</span> ";
                                htmlData += dashes + "\n";


                                total = 0;
                                Object.keys(dataset).forEach(function(xid) {

                                    var dat = dataset[xid];

                                    var diff = new String(Math.floor(dat.balance_diff));

                                    var balance = formatBalance(dat.balance);
                                    var balws = genWhitespace(balance, 8);

                                    htmlData += "<a href=\"#\" coin=\"" + coin + "\" exchange=\"" + xid + "\" mode=\"1\" class=\"showGraph\" title=\"Exchange\">";
                                    htmlData += no2e(xid);
                                    htmlData += "</a>";
                                    htmlData += " = ";

                                    htmlData += balws;
                                    htmlData += "<a href=\"#\" coin=\"" + coin + "\" exchange=\"" + xid + "\" mode=\"0\" class=\"showGraph\" title=\"Total balance\">";
                                    htmlData += balance;
                                    htmlData += "</a>";

                                    htmlData += " (<span title=\"Total opportunities\">";
                                    htmlData += fmt2(dat.opportunities);
                                    htmlData += "</span>|<span title=\"Total trades\">";
                                    htmlData += fmt2(dat.trades);
                                    htmlData += "</span>|";

                                    htmlData += "<a href=\"#\" coin=\"" + coin + "\" exchange=\"" + xid + "\" mode=\"2\" class=\"showGraph\" title=\"Balance change\">";
                                    htmlData += (dat.balance_diff >= 0 ? "+" : "") + diff;
                                    htmlData += "</a>";

                                    htmlData += ")";
                                    htmlData += "\n";

                                    total += parseFloat(dat.balance);
                                });

                                var balance = formatBalance(total);
                                var balws = genWhitespace(balance, 8);

                                htmlData += "<span title=\"Total balance\">T</span> = ";
                                htmlData += balws;
                                htmlData += "<a href=\"#\" coin=\"" + coin + "\" exchange=\"0\" mode=\"0\" class=\"showGraph\" title=\"Total balance\">";
                                htmlData += balance;
                                htmlData += "</a>";
                                htmlData += "\n";
                                htmlData += "\n";
                            });

                            $("#wallets").html("<pre>" + htmlData + "</pre>");
                        }
                    });
                }

                function updateStats() {

                    setTimeout(updateStats, 1000);

                    if (stats === null) {
                        return;
                    }

                    var autobuy = new String(stats.autobuy_funds);
                    autobuy = autobuy.substr(0, autobuy.indexOf('.') + 6);

                    var htmlData = "";
                    htmlData += "     Total trades: " + stats.trades + "\n";
                    htmlData += "    Autobuy funds: " + autobuy + "\n\n";
                    htmlData += "  Next manage-run: " + timeLeft(stats.next_management) + "\n";
                    htmlData += " Next take profit: " + timeLeft(stats.next_take_profit) + "\n";

                    $("#stats").html("<pre>" + htmlData + "</pre>");
                }

                function refreshStats() {

                    setTimeout(refreshStats, 60000);

                    $.ajax({
                        url: "stats.php",
                        type: "GET",
                        cache: false,
                        success: function(data) {
                            stats = data;
                        }
                    });
                }

                refreshStats();
                updateStats();

                updateAge();

                updateGraph();
                updateWallets();
                updateManagement();
                updateTrades();

                updateXfers();
                updateLog();
            });

        </script>

    </head>
    <body>
        <div id="content">

            <div class="floating-container">
                <center><h3 id="graphHeading">Total BTC</h3></center>
                <div class="chart-container">
                    <div id="placeholder" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="floating-container">
                <center><h3 id="wage">Wallets</h3></center>
                <div class="wallet-container">
                    <div id="wallets" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="clear"></div>

            <div class="floating-container">
                <center><h3>Recent trades</h3></center>
                <div class="need-container">
                    <div id="trades" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="floating-container">
                <center><h3>Management</h3></center>
                <div class="need-container">
                    <div id="management" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="floating-container">
                <center><h3>Xfers</h3></center>
                <div class="need-container">
                    <div id="xfers" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="floating-container">
                <center><h3>Stats</h3></center>
                <div class="need-container">
                    <div id="stats" class="demo-placeholder"></div>
                </div>
            </div>

            <div class="clear"></div>

            <div>
                <center><h3>Logfile</h3></center>
                <div class="log-container">
                    <div id="logfile" class="demo-placeholder"></div>
                </div>
            </div>

        </div>

    </body>
</html>
